const tbody = document.querySelector('#list tbody');
const clearBtn = document.getElementById('clearBtn');
const autoScroll = document.getElementById('autoScroll');

const ws = new WebSocket('wss://pumpportal.fun/api/data');

// track tokens
const tokens = {};
const WINDOW_MS = 120 * 1000;
const ALERT_THRESHOLD = 80;

ws.addEventListener('open', () => {
  console.log("Connected to PumpPortal");
  ws.send(JSON.stringify({ method: "subscribeNewToken" }));
  ws.send(JSON.stringify({ method: "subscribeTokenTrade" }));
});

ws.addEventListener('message', (ev) => {
  let msg;
  try { msg = JSON.parse(ev.data); } catch { return; }

  const mint = msg.mint || msg.tokenMint || msg.mintAddress;
  if (!mint) return;

  if (!tokens[mint]) {
    tokens[mint] = {
      mint,
      symbol: msg.symbol || msg.name || "NEW",
      trades: [],
      uniqueBuyers: new Set(),
      firstSeen: Date.now()
    };
  }

  const now = Date.now();
  if (msg.event === "trade" || msg.method === "subscribeTokenTrade") {
    const isBuy = msg.isBuy || (msg.side && msg.side.toLowerCase().includes("buy"));
    const sol = Number(msg.solAmount || msg.sol || 0);
    const buyer = msg.trader || msg.buyer;

    tokens[mint].trades.push({ ts: now, isBuy, sol, buyer });
    if (buyer) tokens[mint].uniqueBuyers.add(buyer);

    // keep trades fresh
    tokens[mint].trades = tokens[mint].trades.filter(tr => tr.ts >= now - WINDOW_MS);

    const buys = tokens[mint].trades.filter(t => t.isBuy).length;
    const sells = tokens[mint].trades.filter(t => !t.isBuy).length;
    const vol = tokens[mint].trades.reduce((s, t) => s + t.sol, 0);
    const uniq = tokens[mint].uniqueBuyers.size;

    const total = buys + sells;
    const buyRatio = total > 0 ? buys / total : 0;
    const volScaled = Math.min(100, Math.log10(1 + vol) * 25 + Math.min(75, vol * 2));
    const uniqScaled = Math.min(100, uniq * 4);
    const score = Math.round(0.45 * buyRatio * 100 + 0.35 * volScaled + 0.20 * uniqScaled);

    if (score >= ALERT_THRESHOLD) {
      renderRow({
        mint,
        symbol: tokens[mint].symbol,
        firstSeen: tokens[mint].firstSeen,
        buys, sells, vol, uniq, score
      });
    }
  }
});

function renderRow(d) {
  const tr = document.createElement('tr');
  const time = new Date(d.firstSeen).toLocaleTimeString();
  const mintShort = d.mint.slice(0,6) + "â¦" + d.mint.slice(-6);

  tr.innerHTML = `
    <td>${time}</td>
    <td>${escapeHtml(d.symbol)}</td>
    <td>${mintShort}</td>
    <td><strong>${d.score}</strong></td>
    <td>${d.buys}</td>
    <td>${d.vol.toFixed(3)}</td>
    <td><a class="link" href="https://pump.fun/coin/${d.mint}" target="_blank">Open</a></td>
  `;

  tbody.prepend(tr);
  if (autoScroll.checked) window.scrollTo({ top: 0, behavior: 'smooth' });
}

clearBtn.addEventListener('click', () => tbody.innerHTML = '');

function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, m => (
    {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]
  ));
}
